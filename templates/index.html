{% extends "base.html" %}

{% block title %}Cockpit Argus Prime{% endblock %}

{% block content %}
<input type="hidden" id="last-user-query" value="">

<div class="hud-container">
    
    <header class="hud-header">
        <div class="sys-stat">
            <span class="label">CPU</span>
            <div class="bar-container"><div class="bar-fill" style="width: 34%;"></div></div>
            <span class="value">34%</span>
        </div>
        <div class="sys-stat">
            <span class="label">RAM</span>
            <div class="bar-container"><div class="bar-fill" style="width: 62%;"></div></div>
            <span class="value">62%</span>
        </div>
        <div class="sys-stat">
            <span class="label">NET</span>
            <span class="value text-green">ONLINE</span>
        </div>
        <div class="sys-stat right">
            <span class="label">PROTOCOL</span>
            <span class="value text-accent">OPENROUTER</span>
        </div>
    </header>

    <main class="main-interface">
        
        <section class="core-column">
            
            <div class="brain-display">
                <div class="brain-selector">
                    <button class="brain-btn" id="btn-operator" onclick="manualSwitch('operator')">‚öôÔ∏è OP</button> 
                    <button class="brain-btn" id="btn-architect" onclick="manualSwitch('architect')">üéì AR</button>
                    <button class="brain-btn" id="btn-strategist" onclick="manualSwitch('strategist')">üíº ST</button>
                    <button class="brain-btn" id="btn-polymath" onclick="manualSwitch('polymath')">‚òï PO</button>
                </div>

                <h1 id="brain-title" class="glitch-text" data-text="{{ brain_name }}">{{ brain_name }}</h1>
                <p id="status-line" class="status-blink">SYSTEM READY</p>
                
                <canvas id="audio-visualizer" width="400" height="60"></canvas>
            </div>

            <div class="interaction-area">
                <div id="chatHistory" class="chat-history"></div>
            </div>

            <div class="command-deck">
                <div class="input-wrapper">
                    <span class="prompt-symbol">></span>
                    <input type="text" id="userMsg" placeholder="Aguardando comando..." autocomplete="off" autofocus>
                    <button id="btnMic" onclick="console.log('Mic clicked')" title="Microfone">üéôÔ∏è</button>
                    <button id="btnSend" onclick="sendMessage()">EXECUTE</button>
                </div>
            </div>
        </section>

        <aside class="side-column">
                <div class="vision-module">
                    <div class="module-header">
                        <span>OPTICAL SENSOR</span>
                        <label class="switch">
                            <input type="checkbox" id="vision-toggle" onclick="toggleVisionModule()">
                            <span class="slider round"></span>
                        </label>
                    </div>
            
                    <div class="camera-feed-placeholder" id="camera-feed">
                        <div class="reticle"></div>
                        <span class="overlay-text">SYSTEM OFFLINE</span> <img id="live-vision" src="" style="display:none; width:100%; height:100%; object-fit: cover;">
                    </div>

                <div class="audio-module">
                <div class="module-header">AUDIO SENSORS</div>
                
                <div class="sensor-row">
                    <span class="sensor-label">MICROPHONE (IN)</span>
                    <label class="switch">
                        <input type="checkbox" id="ears-toggle" onclick="toggleEars()">
                        <span class="slider round"></span>
                    </label>
                </div>

                <div class="sensor-row">
                    <span class="sensor-label">VOCALIZER (OUT)</span>
                    <label class="switch">
                        <input type="checkbox" id="voice-toggle" onclick="toggleVoice()">
                        <span class="slider round"></span>
                    </label>
                </div>

                <div class="audio-stats">
                    <div id="mic-status" class="status-text">MIC: OFFLINE</div>
                    <div id="voice-status" class="status-text">VOICE: MUTED</div>
                </div>
            </div>

            <div class="log-module">
                <div class="module-header">SYSTEM LOGS</div>
                <div class="log-list" id="mini-log">
                    <div class="log-item">Initialyzing Core... OK</div>
                    <div class="log-item">Memory Loaded... OK</div>
                    <div class="log-item">Vision V5 Active</div>
                    <div class="log-item">Audio Filters... OK</div>
                </div>
            </div>
        </aside>

    </main>
</div>

<script>
    // --- L√ìGICA DE INICIALIZA√á√ÉO DO HUD ---
    window.addEventListener('load', function() {
        
        // 1. Configura a COR DO VANTA baseado no C√©rebro Atual
        let colorHex = "{{ brain_color }}";
        let colorInt = 0x3b82f6; // Azul padr√£o (Architect)
        
        // Converte hex do python (#ff0000) para int (0xff0000)
        if (colorHex && colorHex !== "None") {
            colorInt = parseInt(colorHex.replace('#', '0x'));
        }

        // 2. Inicia o Vanta NO ELEMENTO DO BASE.HTML
        if (typeof VANTA !== 'undefined') {
            try {
                window.vantaEffect = VANTA.NET({
                    el: "#vanta-bg", // Pega o ID que est√° no base.html
                    mouseControls: true, touchControls: true, gyroControls: false,
                    minHeight: 200.00, minWidth: 200.00, scale: 1.00, scaleMobile: 1.00,
                    color: colorInt,  // Usa a cor din√¢mica
                    backgroundColor: 0x050505,
                    points: 12.00, maxDistance: 22.00, spacing: 18.00
                });
            } catch (e) {
                console.warn("Vanta falhou ao iniciar:", e);
            }
        }
        
        // 3. Inicia Visualizador de √Åudio
        initVisualizer();
    });

    function initVisualizer() {
        const canvas = document.getElementById('audio-visualizer');
        if(!canvas) return;
        const ctx = canvas.getContext('2d');
        let phase = 0;

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#00f3ff';
            ctx.lineWidth = 2;

            for (let x = 0; x < canvas.width; x++) {
                const y = canvas.height / 2 + 
                          Math.sin(x * 0.05 + phase) * 10 * Math.sin(phase * 0.5) +
                          Math.sin(x * 0.1 + phase * 2) * 5;
                if (x === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();
            phase += 0.1;
            requestAnimationFrame(draw);
        }
        draw();
    }
</script>
{% endblock %}